#!/bin/sh -e

# Update our Raspberry Pi's "cmdline.txt" with the coorect (current) root
# partition and filesystem type. This should really only happen once...
findmnt -no PARTUUID,FSTYPE / | {
	read PARTUUID FSTYPE
	sed -i -E \
		-e "s|^root\s*=.*$|root=PARTUUID=${PARTUUID}|g" \
		-e "s|^rootfstype\s*=.*$|rootfstype=${FSTYPE}|g" \
		/boot/rpi/cmdline.txt
}

# Make sure we have the "gpio" group
groupadd -r gpio
usermod -aG gpio ubuntu

# Prepare the system for booting
if ! test -f "/boot/rpi/kernel8.img"
then
	update-rpi-boot || true
fi
